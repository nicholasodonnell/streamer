version: "3.5"
services:

  client:
    build:
      context: ./client
    container_name: client
    expose:
      - 80
    image: streamer/client:latest
    networks:
      - streamer

  client-dev:
    build:
      context: ./client
      target: base
    command: yarn dev
    container_name: client-dev
    image: streamer/client-dev:latest
    networks:
      - streamer
    ports:
      - ${DEV_PORT:-3000}:3000
    volumes:
      - ./client/.babelrc:/app/.babelrc
      - ./client/.eslintrc:/app/.eslintrc
      - ./client/package.json:/app/package.json
      - ./client/public/favicon.ico:/app/public/favicon.ico
      - ./client/src:/app/src
      - ./client/webpack.config.js:/app/webpack.config.js
      - ./client/yarn.lock:/app/yarn.lock

  gateway:
    build:
      context: ./gateway
    container_name: gateway
    image: streamer/gateway:latest
    networks:
      - streamer
    ports:
      - ${WEB_PORT:-8080}:80
      - ${RTMP_PORT:-1935}:1935

  restreamer:
    build:
      context: ./restreamer
    container_name: restreamer
    environment:
      - RS_INPUTSTREAM=rtmp://127.0.0.1/live/external.stream?token=${RESTREAMER_TOKEN:-secret}
      - RS_PASSWORD=${RESTREAMER_PASSWORD:-password}
      - RS_TOKEN=${RESTREAMER_TOKEN:-secret}
      - RS_USERNAME=${RESTREAMER_USERNAME:-username}
    expose:
      - 1935
      - 8080
    image: streamer/restreamer:latest
    networks:
      - streamer
    volumes:
      - ${RESTREAMER_DATA_PATH:-./restreamer/data}:/restreamer/db

networks:
  streamer:
    driver: bridge
    name: streamer
